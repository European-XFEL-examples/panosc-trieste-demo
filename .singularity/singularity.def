Bootstrap: library
From: centos:7.6.1810

%labels
    Author robert.rosca@xfel.eu

%files
  ./binder /repo/binder
  ./notebooks /repo/notebooks
  ./data /repo/data
  ./.singularity /repo/.singularity

%post
  export logpath=/.singularity.d/logs/
  mkdir -p $logpath

  yum update -y | tee $logpath/00-yum-update.log
  yum install -y \
    nano         \
    curl         \
    tar          \
    bzip2        \
    git          \
  | tee $logpath/01-yum-install.log

  #  Export yum installed to concretise
  yum list installed | tee $logpath/02-yum-list-installed.log

  #  Download and install minconda
  curl -sSL https://repo.anaconda.com/miniconda/Miniconda3-4.6.14-Linux-x86_64.sh -o /tmp/miniconda.sh
  chmod +x /tmp/miniconda.sh
  /tmp/miniconda.sh -bfp /usr/local/
  rm -f /tmp/miniconda.sh
  source /usr/local/bin/activate

  ##  Install from requirements file
  conda env update -n base -f /repo/binder/environment.yml

  ##  Export environment to concretise
  conda env export -n base -f /.singularity.d/logs/03-conda-env-export.log

  #  Extract the data
  mkdir -p /repo/data/SA1/201830/p900025/raw/r0150
  tar -xf /repo/data/SA1-201830-p900025-raw-r0150.tar.gz -C /repo/data/SA1/201830/p900025/raw/r0150
  rm -f /repo/data/SA1-201830-p900025-raw-r0150.tar.gz

  mkdir -p /repo/data/XMPL/201750/p700000/raw/r0008
  tar -xf /repo/data/XMPL-201750-p700000-raw-r0008.tar.gz -C /repo/data/XMPL/201750/p700000/raw/r0008
  rm -f /repo/data/XMPL-201750-p700000-raw-r0008.tar.gz

%apphelp setup
  Copies notebooks and data out of the image and into `./euxfel-trieste`

  Installs a kernel called `euxfel-trieste` which can started by a local instance of Jupyter

%appinstall setup
  chmod +x /repo/.singularity/install.py

%apprun setup
  /repo/.singularity/install.py --name euxfel-trieste
  mkdir -p ./euxfel-trieste
  cp -r /repo/notebooks ./euxfel-trieste/notebooks
  cp -r /repo/data ./euxfel-trieste/data
